---
import Recirculation from "@/components/Recirculation.astro";
import RootLayout from "@/layouts/RootLayout.astro";
import type { Page } from "@/sanity";
import { allPages, pageBySlugQuery } from "@/utils/queries";
import { astroI18n } from "astro-i18n";
import { sanityClient } from "sanity:client";
import { createGetStaticPaths } from "astro-i18n";

export const getStaticPaths = createGetStaticPaths(async () => {
  // const { locale } = astroI18n; We no longer do whole diff documents
  const slugs = await sanityClient.fetch<{ slug: string }[]>(allPages);
  return slugs.map(({ slug }) => ({ params: { slug } }));
});

const { locale, primaryLocale, route } = astroI18n;
const slug = route.replace("/", "");

const page = await sanityClient.fetch<Page | null>(pageBySlugQuery, {
  slug,
  locale,
  primaryLocale,
});
if (!page) {
  astroI18n.redirect("/404");
}
---

<RootLayout>
  {page && page.recirculation && <Recirculation recirc={page.recirculation} />}
</RootLayout>

<style></style>
